<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>MoodMirror</title>
        <meta
            name="description"
            content="Real-time emotion detection using AI facial recognition"
        />
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"
        ></script>
        <style>
            :root {
                --primary: #f97316;
                --primary-dark: #ea580c;
                --primary-light: #fb923c;
                --accent: #22c55e;
                --accent-dark: #16a34a;
                --success: #22c55e;
                --warning: #f59e0b;
                --danger: #ef4444;
                --neutral-50: #ffffff;
                --neutral-100: #fafafa;
                --neutral-200: #f5f5f5;
                --neutral-300: #e5e5e5;
                --neutral-400: #a3a3a3;
                --neutral-500: #737373;
                --neutral-600: #525252;
                --neutral-700: #404040;
                --neutral-800: #262626;
                --neutral-900: #171717;
                --glass-bg: rgba(255, 255, 255, 0.85);
                --glass-border: rgba(255, 255, 255, 0.5);
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    "Helvetica Neue", Arial, sans-serif;
                background: linear-gradient(135deg, #f97316 0%, #22c55e 50%, #16a34a 100%);
                background-attachment: fixed;
                color: var(--neutral-800);
                line-height: 1.6;
                min-height: 100vh;
                overflow-x: hidden;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 24px;
            }

            .screen {
                display: none;
                min-height: 100vh;
            }

            .screen.active {
                display: block;
                animation: fadeIn 0.5s ease-out;
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .loading-screen {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                background: linear-gradient(135deg, #f97316 0%, #ea580c 50%, #c2410c 100%);
                position: relative;
                overflow: hidden;
            }

            .loading-screen::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: radial-gradient(circle, rgba(34, 197, 94, 0.15) 0%, transparent 50%);
                animation: rotate 20s linear infinite;
            }

            @keyframes rotate {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }

            .loading-content {
                position: relative;
                z-index: 1;
                text-align: center;
            }

            .loading-logo-container {
                position: relative;
                width: 160px;
                height: 160px;
                margin: 0 auto 40px;
            }

            .loading-logo-ring {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                border: 3px solid transparent;
                border-top-color: var(--primary);
                border-radius: 50%;
                animation: spin 1.5s linear infinite;
            }

            .loading-logo-ring:nth-child(2) {
                width: 85%;
                height: 85%;
                top: 7.5%;
                left: 7.5%;
                border-top-color: var(--primary-light);
                animation-duration: 2s;
                animation-direction: reverse;
            }

            .loading-logo-ring:nth-child(3) {
                width: 70%;
                height: 70%;
                top: 15%;
                left: 15%;
                border-top-color: var(--accent);
                animation-duration: 1s;
            }

            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }

            .loading-logo {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90px;
                height: 90px;
                border-radius: 50%;
                animation: pulse-glow 2s ease-in-out infinite;
                object-fit: cover;
            }

            @keyframes pulse-glow {
                0%, 100% { 
                    box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
                    transform: translate(-50%, -50%) scale(1);
                }
                50% { 
                    box-shadow: 0 0 40px rgba(34, 197, 94, 0.8);
                    transform: translate(-50%, -50%) scale(1.05);
                }
            }

            .loading-title {
                font-size: 42px;
                font-weight: 800;
                background: linear-gradient(135deg, #fff 0%, #bbf7d0 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                margin-bottom: 16px;
                letter-spacing: -1px;
            }

            .loading-subtitle {
                color: rgba(255, 255, 255, 0.7);
                font-size: 16px;
                margin-bottom: 48px;
            }

            .loading-progress {
                width: 280px;
                margin: 0 auto;
            }

            .loading-progress-bar {
                width: 100%;
                height: 6px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 3px;
                overflow: hidden;
                margin-bottom: 16px;
            }

            .loading-progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #22c55e 0%, #ffffff 100%);
                border-radius: 3px;
                width: 0%;
                transition: width 0.3s ease;
            }

            .loading-status {
                color: rgba(255, 255, 255, 0.6);
                font-size: 14px;
            }

            .loading-dots::after {
                content: '';
                animation: dots 1.5s infinite;
            }

            @keyframes dots {
                0%, 20% { content: '.'; }
                40% { content: '..'; }
                60%, 100% { content: '...'; }
            }

            .card {
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-radius: 24px;
                padding: 48px;
                border: 1px solid var(--glass-border);
                box-shadow: var(--shadow-xl);
                width: 100%;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .card:hover {
                transform: translateY(-4px);
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }

            .header {
                text-align: center;
                margin-bottom: 40px;
            }

            .logo {
                width: 120px;
                height: 120px;
                margin: 0 auto 24px;
                display: block;
                border-radius: 50%;
                box-shadow: var(--shadow-lg);
                transition: transform 0.3s ease;
                object-fit: cover;
            }

            .logo:hover {
                transform: scale(1.08) rotate(3deg);
            }

            h1 {
                font-size: 36px;
                font-weight: 800;
                margin-bottom: 12px;
                background: linear-gradient(135deg, #f97316 0%, #22c55e 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                letter-spacing: -1px;
            }

            .subtitle {
                color: var(--neutral-500);
                font-size: 16px;
                font-weight: 500;
            }

            button {
                padding: 16px 32px;
                background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
                color: white;
                border: none;
                border-radius: 14px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 4px 14px 0 rgba(249, 115, 22, 0.4);
                position: relative;
                overflow: hidden;
            }

            button::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                transition: left 0.5s ease;
            }

            button:hover:not(:disabled)::before {
                left: 100%;
            }

            button:hover:not(:disabled) {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px 0 rgba(249, 115, 22, 0.5);
            }

            button:active:not(:disabled) {
                transform: translateY(-1px);
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            button.secondary {
                background: linear-gradient(135deg, var(--neutral-100) 0%, var(--neutral-200) 100%);
                color: var(--neutral-700);
                box-shadow: var(--shadow-md);
            }

            button.secondary:hover:not(:disabled) {
                background: linear-gradient(135deg, var(--neutral-200) 0%, var(--neutral-300) 100%);
                box-shadow: var(--shadow-lg);
            }

            button.danger {
                background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
                box-shadow: 0 4px 14px 0 rgba(239, 68, 68, 0.4);
            }

            button.danger:hover:not(:disabled) {
                box-shadow: 0 8px 20px 0 rgba(239, 68, 68, 0.5);
            }

            .start-card {
                max-width: 650px;
                margin: 60px auto;
            }

            .feature-list {
                text-align: left;
                margin: 32px 0;
                padding: 28px;
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(249, 115, 22, 0.05) 100%);
                border-radius: 16px;
                border: 1px solid rgba(99, 102, 241, 0.1);
            }

            .feature-item {
                display: flex;
                align-items: center;
                margin: 18px 0;
                color: var(--neutral-600);
                font-size: 15px;
                font-weight: 500;
            }

            .feature-item::before {
                content: "";
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 32px;
                height: 32px;
                margin-right: 16px;
                background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
                border-radius: 10px;
                flex-shrink: 0;
            }

            .feature-item::after {
                content: "âœ“";
                position: absolute;
                color: white;
                font-weight: bold;
                font-size: 14px;
                margin-left: 9px;
            }

            .feature-item {
                position: relative;
            }

            .dashboard-grid {
                display: grid;
                grid-template-columns: 1fr 380px;
                gap: 24px;
                margin-top: 20px;
            }

            .video-section {
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-radius: 20px;
                padding: 24px;
                border: 1px solid var(--glass-border);
                box-shadow: var(--shadow-xl);
            }

            .section-title {
                font-size: 20px;
                font-weight: 700;
                margin-bottom: 20px;
                color: var(--neutral-800);
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .section-title::before {
                content: '';
                width: 4px;
                height: 24px;
                background: linear-gradient(180deg, #f97316 0%, #22c55e 100%);
                border-radius: 2px;
            }

            .video-container {
                position: relative;
                background: linear-gradient(135deg, var(--neutral-900) 0%, var(--neutral-800) 100%);
                border-radius: 16px;
                overflow: hidden;
                aspect-ratio: 16 / 9;
                margin-bottom: 20px;
                box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            video,
            canvas {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            canvas {
                position: absolute;
                top: 0;
                left: 0;
            }

            .badge {
                position: absolute;
                top: 16px;
                right: 16px;
                padding: 10px 18px;
                border-radius: 30px;
                font-size: 13px;
                font-weight: 600;
                background: rgba(0, 0, 0, 0.75);
                backdrop-filter: blur(10px);
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .badge::before {
                content: '';
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--neutral-400);
                animation: none;
            }

            .badge.scanning::before {
                background: var(--success);
                animation: blink 1s ease-in-out infinite;
            }

            @keyframes blink {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.4; }
            }

            .sidebar {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            .stats-card {
                background: var(--glass-bg);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border-radius: 20px;
                padding: 24px;
                border: 1px solid var(--glass-border);
                box-shadow: var(--shadow-lg);
            }

            .stats-card h3 {
                font-size: 13px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: var(--neutral-500);
                margin-bottom: 20px;
            }

            .stat-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 16px 0;
                border-bottom: 1px solid var(--neutral-200);
            }

            .stat-row:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

            .stat-label {
                font-size: 14px;
                color: var(--neutral-500);
                font-weight: 500;
            }

            .stat-value {
                font-size: 28px;
                font-weight: 800;
                background: linear-gradient(135deg, #f97316 0%, #22c55e 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }

            .people-list {
                max-height: 450px;
                overflow-y: auto;
                padding-right: 8px;
            }

            .people-list::-webkit-scrollbar {
                width: 6px;
            }

            .people-list::-webkit-scrollbar-track {
                background: var(--neutral-100);
                border-radius: 3px;
            }

            .people-list::-webkit-scrollbar-thumb {
                background: var(--neutral-300);
                border-radius: 3px;
            }

            .person-card {
                background: white;
                border: 2px solid var(--neutral-200);
                border-radius: 14px;
                padding: 18px;
                margin-bottom: 14px;
                transition: all 0.3s ease;
            }

            .person-card:hover {
                border-color: var(--primary-light);
                box-shadow: var(--shadow-md);
            }

            .person-card.new {
                border-color: var(--success);
                background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
                animation: slideIn 0.4s ease-out, glow 2s ease-in-out;
            }

            @keyframes slideIn {
                from { 
                    opacity: 0; 
                    transform: translateX(-20px);
                }
                to { 
                    opacity: 1; 
                    transform: translateX(0);
                }
            }

            @keyframes glow {
                0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
                50% { box-shadow: 0 0 20px 0 rgba(16, 185, 129, 0.3); }
            }

            .person-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 14px;
            }

            .person-id {
                font-size: 15px;
                font-weight: 700;
                color: var(--neutral-800);
            }

            .new-badge {
                background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
                color: white;
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 11px;
                font-weight: 700;
                letter-spacing: 0.5px;
                text-transform: uppercase;
            }

            .emotion-badge {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 10px 18px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                margin-top: 8px;
            }

            .emotion-happy {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                color: #92400e;
            }
            .emotion-sad {
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
                color: #1e40af;
            }
            .emotion-neutral {
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                color: #374151;
            }
            .emotion-surprised {
                background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
                color: #6b21a8;
            }
            .emotion-angry {
                background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
                color: #991b1b;
            }
            .emotion-fearful {
                background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
                color: #9a3412;
            }
            .emotion-disgusted {
                background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
                color: #065f46;
            }

            .confidence-bar {
                margin-top: 12px;
            }

            .confidence-label {
                font-size: 12px;
                color: var(--neutral-500);
                margin-bottom: 6px;
                font-weight: 500;
            }

            .progress {
                width: 100%;
                height: 8px;
                background: var(--neutral-200);
                border-radius: 4px;
                overflow: hidden;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #f97316 0%, #22c55e 100%);
                border-radius: 4px;
                transition: width 0.4s ease;
            }

            .button-group {
                display: flex;
                gap: 14px;
                margin-top: 20px;
            }

            .button-group button {
                flex: 1;
            }

            .summary-screen {
                max-width: 1000px;
                margin: 40px auto;
            }

            .summary-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
                margin: 28px 0;
            }

            .summary-stat {
                background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
                color: white;
                padding: 28px;
                border-radius: 18px;
                text-align: center;
                box-shadow: 0 8px 20px -4px rgba(249, 115, 22, 0.4);
                transition: transform 0.3s ease;
            }

            .summary-stat:hover {
                transform: translateY(-4px);
            }

            .summary-stat.positive {
                background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
                box-shadow: 0 8px 20px -4px rgba(16, 185, 129, 0.4);
            }

            .summary-stat.neutral {
                background: linear-gradient(135deg, var(--neutral-500) 0%, var(--neutral-600) 100%);
                box-shadow: 0 8px 20px -4px rgba(115, 115, 115, 0.4);
            }

            .summary-stat.negative {
                background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
                box-shadow: 0 8px 20px -4px rgba(239, 68, 68, 0.4);
            }

            .summary-stat-label {
                font-size: 13px;
                opacity: 0.9;
                margin-bottom: 10px;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .summary-stat-value {
                font-size: 42px;
                font-weight: 800;
            }

            .emotion-breakdown {
                background: white;
                padding: 28px;
                border-radius: 18px;
                margin: 24px 0;
                box-shadow: var(--shadow-md);
            }

            .emotion-breakdown h3 {
                font-size: 18px;
                font-weight: 700;
                margin-bottom: 24px;
                color: var(--neutral-800);
            }

            .emotion-bar-item {
                margin-bottom: 18px;
            }

            .emotion-bar-header {
                display: flex;
                justify-content: space-between;
                font-size: 14px;
                margin-bottom: 8px;
            }

            .emotion-bar-header strong {
                font-weight: 600;
                color: var(--neutral-800);
            }

            .emotion-bar-header span {
                color: var(--neutral-500);
            }

            .info-box {
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(99, 102, 241, 0.04) 100%);
                border: 1px solid rgba(99, 102, 241, 0.2);
                border-radius: 14px;
                padding: 18px;
                margin-bottom: 16px;
            }

            .info-box p {
                color: var(--primary-dark);
                font-size: 14px;
                margin: 0;
                line-height: 1.6;
            }

            @media (max-width: 1024px) {
                .dashboard-grid {
                    grid-template-columns: 1fr;
                }
                
                .sidebar {
                    order: -1;
                }
            }

            @media (max-width: 640px) {
                .container {
                    padding: 16px;
                }

                .card {
                    padding: 28px;
                }

                h1 {
                    font-size: 28px;
                }

                .loading-title {
                    font-size: 32px;
                }

                .summary-stat-value {
                    font-size: 32px;
                }
            }

            .hidden {
                display: none !important;
            }

            .empty-state {
                text-align: center;
                padding: 32px 20px;
                color: var(--neutral-400);
            }

            .empty-state-icon {
                font-size: 48px;
                margin-bottom: 12px;
            }

            .empty-state-text {
                font-size: 14px;
                font-weight: 500;
            }
        </style>
    </head>
    <body>
        <!-- LOADING SCREEN -->
        <div id="loadingScreen" class="screen active">
            <div class="loading-screen">
                <div class="loading-content">
                    <div class="loading-logo-container">
                        <div class="loading-logo-ring"></div>
                        <div class="loading-logo-ring"></div>
                        <div class="loading-logo-ring"></div>
                        <img src="attached_assets/IMG_4858_1764856897036.jpeg" class="loading-logo" alt="Calaca City Global College Logo" />
                    </div>
                    <h1 class="loading-title">MoodMirror</h1>
                    <div class="loading-progress">
                        <div class="loading-progress-bar">
                            <div class="loading-progress-fill" id="loadingProgressFill"></div>
                        </div>
                        <p class="loading-status" id="loadingStatus">Initializing<span class="loading-dots"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- START SCREEN -->
        <div id="startScreen" class="screen">
            <div class="container">
                <div class="card start-card">
                    <div class="header">
                        <img src="attached_assets/IMG_4858_1764856897036.jpeg" class="logo" alt="Calaca City Global College Logo" />
                        <h1>MoodMirror</h1>
                        <p class="subtitle">Calaca City Global College</p>
                    </div>

                    <button id="startScanButton" style="width: 100%;">
                        Start Scan
                    </button>
                </div>
            </div>
        </div>

        <!-- TRACKING SCREEN -->
        <div id="trackingScreen" class="screen">
            <div class="container">
                <div class="dashboard-grid">
                    <div class="video-section">
                        <h2 class="section-title">Live Camera Feed</h2>
                        <div class="video-container">
                            <video id="video" autoplay muted playsinline></video>
                            <canvas id="canvas"></canvas>
                            <span id="statusBadge" class="badge">Initializing...</span>
                        </div>

                        <div class="button-group">
                            <button id="endSessionButton">End Session</button>
                            <button id="cancelButton" class="secondary">Cancel</button>
                        </div>
                    </div>

                    <div class="sidebar">
                        <div class="stats-card">
                            <h3>Session Stats</h3>
                            <div class="stat-row">
                                <span class="stat-label">Unique People</span>
                                <span class="stat-value" id="uniquePeopleCount">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Currently Visible</span>
                                <span class="stat-value" id="visibleFacesCount">0</span>
                            </div>
                        </div>

                        <div class="stats-card">
                            <h3>Tracked Individuals</h3>
                            <div id="peopleList" class="people-list">
                                <div class="empty-state">
                                    <div class="empty-state-icon">ðŸ‘¤</div>
                                    <p class="empty-state-text">No people detected yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SUMMARY SCREEN -->
        <div id="summaryScreen" class="screen">
            <div class="container summary-screen">
                <div class="card">
                    <div class="header">
                        <h1>Session Summary</h1>
                        <p class="subtitle">Event satisfaction analysis complete</p>
                    </div>

                    <div class="summary-grid">
                        <div class="summary-stat">
                            <div class="summary-stat-label">Total People</div>
                            <div class="summary-stat-value" id="summaryTotalPeople">0</div>
                        </div>
                        <div class="summary-stat positive">
                            <div class="summary-stat-label">Positive Emotions</div>
                            <div class="summary-stat-value" id="summaryPositive">0</div>
                        </div>
                        <div class="summary-stat neutral">
                            <div class="summary-stat-label">Neutral</div>
                            <div class="summary-stat-value" id="summaryNeutral">0</div>
                        </div>
                        <div class="summary-stat negative">
                            <div class="summary-stat-label">Negative Emotions</div>
                            <div class="summary-stat-value" id="summaryNegative">0</div>
                        </div>
                    </div>

                    <div class="emotion-breakdown">
                        <h3>Emotion Distribution</h3>
                        <div id="emotionBreakdown"></div>
                    </div>

                    <div class="button-group">
                        <button id="newSessionButton">New Session</button>
                        <button id="exportButton" class="secondary">Export Data</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const FACE_MATCH_THRESHOLD = 0.65;
            const UPDATE_INTERVAL = 300;
            const NEW_FACE_DISPLAY_TIME = 5000;
            const MAX_DESCRIPTORS_PER_PERSON = 5;
            let lastNotificationTime = 0;

            let modelsLoaded = false;
            let stream = null;
            let detectionInterval = null;
            let trackedPeople = [];
            let personIdCounter = 1;

            const emotionLabels = {
                neutral: "Neutral",
                happy: "Happy",
                sad: "Sad",
                angry: "Angry",
                fearful: "Fearful",
                disgusted: "Disgusted",
                surprised: "Surprised",
            };

            const emotionCategories = {
                positive: ['happy', 'surprised'],
                neutral: ['neutral'],
                negative: ['sad', 'angry', 'fearful', 'disgusted']
            };

            const emotionBoostFactors = {
                disgusted: 3.5,
                angry: 2.8,
                fearful: 2.5,
                sad: 2.2,
                surprised: 2.0,
                happy: 1.5,
                neutral: 0.4
            };

            const emotionMinThresholds = {
                disgusted: 0.03,
                angry: 0.05,
                fearful: 0.04,
                sad: 0.05,
                surprised: 0.08,
                happy: 0.10,
                neutral: 0.50
            };

            function getEnhancedEmotion(expressions) {
                const adjustedScores = {};
                
                for (const [emotion, rawScore] of Object.entries(expressions)) {
                    const boost = emotionBoostFactors[emotion] || 1.0;
                    const minThreshold = emotionMinThresholds[emotion] || 0.1;
                    
                    if (rawScore >= minThreshold) {
                        adjustedScores[emotion] = rawScore * boost;
                    } else {
                        adjustedScores[emotion] = rawScore * 0.3;
                    }
                }

                const nonNeutralEmotions = Object.entries(expressions)
                    .filter(([e]) => e !== 'neutral')
                    .reduce((sum, [, score]) => sum + score, 0);
                
                if (nonNeutralEmotions > 0.10) {
                    adjustedScores.neutral *= 0.3;
                }
                if (nonNeutralEmotions > 0.20) {
                    adjustedScores.neutral *= 0.2;
                }

                const disgustIndicators = 
                    (expressions.disgusted || 0) + 
                    (expressions.angry || 0) * 0.4 + 
                    (expressions.sad || 0) * 0.25;
                
                if (disgustIndicators > 0.08 && expressions.disgusted > 0.02) {
                    adjustedScores.disgusted *= 2.0;
                }

                const angerIndicators = 
                    (expressions.angry || 0) + 
                    (expressions.disgusted || 0) * 0.3;
                
                if (angerIndicators > 0.10 && expressions.angry > 0.04) {
                    adjustedScores.angry *= 1.5;
                }

                const sadIndicators = 
                    (expressions.sad || 0) + 
                    (expressions.fearful || 0) * 0.3;
                
                if (sadIndicators > 0.10 && expressions.sad > 0.04) {
                    adjustedScores.sad *= 1.5;
                }

                const fearIndicators = 
                    (expressions.fearful || 0) + 
                    (expressions.surprised || 0) * 0.3 +
                    (expressions.sad || 0) * 0.2;
                
                if (fearIndicators > 0.10 && expressions.fearful > 0.03) {
                    adjustedScores.fearful *= 1.5;
                }

                let bestEmotion = 'neutral';
                let highestScore = 0;
                
                for (const [emotion, score] of Object.entries(adjustedScores)) {
                    if (score > highestScore) {
                        highestScore = score;
                        bestEmotion = emotion;
                    }
                }

                return {
                    emotion: bestEmotion,
                    confidence: expressions[bestEmotion] * 100,
                    adjustedConfidence: highestScore * 100 / (emotionBoostFactors[bestEmotion] || 1)
                };
            }

            function updateLoadingProgress(percent, statusText) {
                const progressFill = document.getElementById('loadingProgressFill');
                const statusElement = document.getElementById('loadingStatus');
                
                if (progressFill) {
                    progressFill.style.width = percent + '%';
                }
                if (statusElement) {
                    statusElement.innerHTML = statusText + '<span class="loading-dots"></span>';
                }
            }

            async function loadModels() {
                const MODEL_URL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";
                
                try {
                    updateLoadingProgress(10, 'Loading face detector');
                    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                    
                    updateLoadingProgress(30, 'Loading expression analyzer');
                    await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
                    
                    updateLoadingProgress(55, 'Loading landmark detector');
                    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                    
                    updateLoadingProgress(80, 'Loading recognition model');
                    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
                    
                    updateLoadingProgress(100, 'Ready');
                    
                    modelsLoaded = true;
                    console.log("AI models loaded successfully");
                    
                    setTimeout(() => {
                        showScreen('startScreen');
                    }, 800);
                    
                } catch (error) {
                    console.error("Error loading models:", error);
                    updateLoadingProgress(0, 'Error loading models - Please refresh');
                }
            }

            function euclideanDistance(descriptor1, descriptor2) {
                return Math.sqrt(
                    descriptor1.reduce((sum, val, i) => 
                        sum + Math.pow(val - descriptor2[i], 2), 0
                    )
                );
            }

            function findMatchingPerson(descriptor) {
                let bestMatch = null;
                let lowestDistance = Infinity;

                for (const person of trackedPeople) {
                    for (const storedDescriptor of person.descriptors) {
                        const distance = euclideanDistance(descriptor, storedDescriptor);
                        if (distance < lowestDistance) {
                            lowestDistance = distance;
                            bestMatch = person;
                        }
                    }
                }

                if (lowestDistance < FACE_MATCH_THRESHOLD) {
                    console.log(`Matched to Person #${bestMatch.id} (distance: ${lowestDistance.toFixed(3)})`);
                    return bestMatch;
                }
                const distanceStr = lowestDistance === Infinity ? 'N/A' : lowestDistance.toFixed(3);
                console.log(`New person detected (closest distance: ${distanceStr}, threshold: ${FACE_MATCH_THRESHOLD})`);
                return null;
            }

            function updatePerson(person, descriptor, emotion, expressions, confidence) {
                person.lastSeen = Date.now();
                person.updateCount++;
                
                if (!person.scanned) {
                    person.emotion = emotion;
                    person.expressions = expressions;
                    person.confidence = confidence;
                    person.initialFrameCount++;
                    
                    if (person.descriptors.length < MAX_DESCRIPTORS_PER_PERSON) {
                        person.descriptors.push(descriptor);
                        console.log(`  Added descriptor ${person.descriptors.length}/${MAX_DESCRIPTORS_PER_PERSON} to Person #${person.id}`);
                    }
                    
                    if (person.initialFrameCount >= 3 || person.descriptors.length >= MAX_DESCRIPTORS_PER_PERSON) {
                        finalizePersonScan(person);
                    }
                } else {
                    if (Date.now() - lastNotificationTime > 2000) {
                        showNotification(`Person #${person.id} already detected`, 'already');
                        console.log(`Person #${person.id} already scanned - skipping`);
                        lastNotificationTime = Date.now();
                    }
                }
                
                person.isNew = false;
            }

            function addNewPerson(descriptor, emotion, expressions, confidence) {
                const person = {
                    id: personIdCounter++,
                    descriptors: [descriptor],
                    emotion: emotion,
                    expressions: expressions,
                    confidence: confidence,
                    firstSeen: Date.now(),
                    lastSeen: Date.now(),
                    updateCount: 1,
                    isNew: true,
                    scanned: false,
                    initialFrameCount: 1
                };
                trackedPeople.push(person);
                
                setTimeout(() => {
                    person.isNew = false;
                    updatePeopleList();
                }, NEW_FACE_DISPLAY_TIME);

                showNotification(`Person #${person.id} detected - ${emotionLabels[emotion]}`, 'new');
                console.log(`New person #${person.id} - ${emotionLabels[emotion]} (${confidence.toFixed(1)}%)`);

                return person;
            }

            function finalizePersonScan(person) {
                person.scanned = true;
                showNotification(`Person #${person.id} scan complete - ${emotionLabels[person.emotion]}`, 'complete');
                console.log(`Person #${person.id} scan finalized with emotion: ${emotionLabels[person.emotion]}`);
            }

            function showNotification(message, type) {
                const statusBadge = document.getElementById('statusBadge');
                const originalText = statusBadge.textContent;
                const originalClass = statusBadge.className;
                
                statusBadge.textContent = message;
                if (type === 'new') {
                    statusBadge.className = 'badge scanning';
                } else if (type === 'complete') {
                    statusBadge.className = 'badge scanning';
                } else if (type === 'already') {
                    statusBadge.className = 'badge';
                    statusBadge.style.background = 'rgba(245, 158, 11, 0.9)';
                    statusBadge.style.color = 'white';
                }
                
                setTimeout(() => {
                    statusBadge.textContent = originalText;
                    statusBadge.className = originalClass;
                    statusBadge.style.background = '';
                    statusBadge.style.color = '';
                }, 2000);
            }

            async function detectFaces() {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                
                if (!video || video.paused || video.ended) return;

                const displaySize = { 
                    width: video.videoWidth, 
                    height: video.videoHeight 
                };
                
                faceapi.matchDimensions(canvas, displaySize);

                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({
                        inputSize: 416,
                        scoreThreshold: 0.5
                    }))
                    .withFaceLandmarks()
                    .withFaceExpressions()
                    .withFaceDescriptors();

                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                document.getElementById('visibleFacesCount').textContent = detections.length;

                if (detections.length > 0) {
                    document.getElementById('statusBadge').textContent = 
                        `Scanning ${detections.length} face${detections.length > 1 ? 's' : ''}`;
                    document.getElementById('statusBadge').className = 'badge scanning';

                    detections.forEach((detection) => {
                        const descriptor = Array.from(detection.descriptor);
                        const expressions = detection.expressions;
                        
                        const emotionResult = getEnhancedEmotion(expressions);
                        const emotion = emotionResult.emotion;
                        const confidence = emotionResult.confidence;

                        const matchingPerson = findMatchingPerson(descriptor);
                        let person, labelText;

                        if (matchingPerson) {
                            updatePerson(matchingPerson, descriptor, emotion, expressions, confidence);
                            person = matchingPerson;
                            labelText = person.scanned ? 'Already detected' : emotionLabels[emotion];
                        } else {
                            person = addNewPerson(descriptor, emotion, expressions, confidence);
                            labelText = emotionLabels[emotion];
                        }

                        const box = detection.detection.box;
                        
                        if (person.scanned) {
                            ctx.strokeStyle = '#f59e0b';
                            ctx.fillStyle = '#f59e0b';
                        } else {
                            ctx.strokeStyle = '#10b981';
                            ctx.fillStyle = '#10b981';
                        }
                        
                        ctx.lineWidth = 3;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);

                        ctx.font = 'bold 16px Inter, Arial';
                        ctx.fillText(
                            labelText, 
                            box.x, 
                            box.y > 20 ? box.y - 10 : box.y + box.height + 20
                        );
                    });

                    updatePeopleList();
                    updateStats();
                } else {
                    document.getElementById('statusBadge').textContent = 'No faces detected';
                    document.getElementById('statusBadge').className = 'badge';
                }
            }

            function updatePeopleList() {
                const peopleList = document.getElementById('peopleList');
                
                if (trackedPeople.length === 0) {
                    peopleList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ‘¤</div>
                            <p class="empty-state-text">No people detected yet</p>
                        </div>
                    `;
                    return;
                }

                const sortedPeople = [...trackedPeople].sort((a, b) => b.lastSeen - a.lastSeen);

                peopleList.innerHTML = sortedPeople.map(person => `
                    <div class="person-card ${person.isNew ? 'new' : ''}">
                        <div class="person-header">
                            <span class="person-id">Person #${person.id}</span>
                            ${person.isNew ? '<span class="new-badge">NEW</span>' : ''}
                        </div>
                        <div class="emotion-badge emotion-${person.emotion}">
                            ${emotionLabels[person.emotion]}
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-label">Confidence: ${person.confidence.toFixed(1)}%</div>
                            <div class="progress">
                                <div class="progress-fill" style="width: ${person.confidence}%"></div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function updateStats() {
                document.getElementById('uniquePeopleCount').textContent = trackedPeople.length;
            }

            async function startCamera() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'user' },
                        audio: false
                    });

                    const video = document.getElementById('video');
                    video.srcObject = stream;

                    await new Promise((resolve) => {
                        video.onloadedmetadata = () => resolve();
                    });

                    await video.play();

                    if (!modelsLoaded) {
                        document.getElementById('statusBadge').textContent = 'Loading AI models...';
                        await loadModels();
                    }

                    detectionInterval = setInterval(detectFaces, UPDATE_INTERVAL);
                    document.getElementById('statusBadge').textContent = 'Ready to scan';

                } catch (error) {
                    console.error("Camera error:", error);
                    alert("Could not access camera. Please check permissions.");
                    showScreen('startScreen');
                }
            }

            function stopCamera() {
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }

                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }

                const video = document.getElementById('video');
                if (video) {
                    video.srcObject = null;
                }
            }

            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
            }

            function showSummary() {
                stopCamera();

                const totalPeople = trackedPeople.length;
                document.getElementById('summaryTotalPeople').textContent = totalPeople;

                const emotionCounts = {
                    positive: 0,
                    neutral: 0,
                    negative: 0
                };

                const detailedCounts = {};
                Object.keys(emotionLabels).forEach(e => detailedCounts[e] = 0);

                trackedPeople.forEach(person => {
                    detailedCounts[person.emotion]++;
                    
                    for (const [category, emotions] of Object.entries(emotionCategories)) {
                        if (emotions.includes(person.emotion)) {
                            emotionCounts[category]++;
                            break;
                        }
                    }
                });

                document.getElementById('summaryPositive').textContent = emotionCounts.positive;
                document.getElementById('summaryNeutral').textContent = emotionCounts.neutral;
                document.getElementById('summaryNegative').textContent = emotionCounts.negative;

                const breakdownHTML = Object.entries(detailedCounts)
                    .sort(([, a], [, b]) => b - a)
                    .map(([emotion, count]) => {
                        const percentage = totalPeople > 0 ? (count / totalPeople) * 100 : 0;
                        return `
                            <div class="emotion-bar-item">
                                <div class="emotion-bar-header">
                                    <strong>${emotionLabels[emotion]}</strong>
                                    <span>${count} people (${percentage.toFixed(1)}%)</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');

                document.getElementById('emotionBreakdown').innerHTML = breakdownHTML;

                showScreen('summaryScreen');
            }

            function exportData() {
                const data = {
                    sessionDate: new Date().toISOString(),
                    totalPeople: trackedPeople.length,
                    people: trackedPeople.map(person => ({
                        id: person.id,
                        emotion: emotionLabels[person.emotion],
                        confidence: person.confidence.toFixed(2) + '%',
                        firstSeen: new Date(person.firstSeen).toISOString(),
                        lastSeen: new Date(person.lastSeen).toISOString(),
                        updateCount: person.updateCount
                    })),
                    summary: {
                        positive: trackedPeople.filter(p => 
                            emotionCategories.positive.includes(p.emotion)
                        ).length,
                        neutral: trackedPeople.filter(p => 
                            emotionCategories.neutral.includes(p.emotion)
                        ).length,
                        negative: trackedPeople.filter(p => 
                            emotionCategories.negative.includes(p.emotion)
                        ).length
                    }
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `moodmirror-report-${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function resetSession() {
                trackedPeople = [];
                personIdCounter = 1;
                updatePeopleList();
                updateStats();
            }

            document.getElementById('startScanButton').addEventListener('click', () => {
                resetSession();
                showScreen('trackingScreen');
                startCamera();
            });

            document.getElementById('endSessionButton').addEventListener('click', showSummary);

            document.getElementById('cancelButton').addEventListener('click', () => {
                stopCamera();
                resetSession();
                showScreen('startScreen');
            });

            document.getElementById('newSessionButton').addEventListener('click', () => {
                resetSession();
                showScreen('startScreen');
            });

            document.getElementById('exportButton').addEventListener('click', exportData);

            window.addEventListener('DOMContentLoaded', loadModels);
        </script>
    </body>
</html>
