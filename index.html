<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MoodMirror - AI Face Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #fafafa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
        }

        .screen.active {
            display: flex;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }

        .card-wide {
            max-width: 1200px;
        }

        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 16px;
            display: block;
            object-fit: contain;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1a202c;
        }

        .subtitle {
            color: #718096;
            font-size: 14px;
        }

        button {
            width: 100%;
            padding: 12px 24px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover:not(:disabled) {
            background: #1a252f;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.secondary {
            background: #e2e8f0;
            color: #2c3e50;
        }

        button.secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .video-container {
            position: relative;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16 / 9;
            margin-bottom: 20px;
        }

        video, canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .scan-info {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .face-emotion-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
        }

        .face-emotion-card h4 {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #718096;
            margin-bottom: 8px;
        }

        .emotion-bar {
            margin-bottom: 12px;
        }

        .emotion-bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .emotion-bar-label strong {
            font-weight: 600;
        }

        .progress {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #3182ce;
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #718096;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2c3e50;
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        .emotions-panel {
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            max-height: 600px;
            overflow-y: auto;
        }

        .emotions-panel h3 {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            color: #4a5568;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- START SCREEN -->
    <div id="startScreen" class="screen active">
        <div class="container">
            <div class="card">
                <div class="header">
                    <img src="data:image/jpeg;base64,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" class="logo" alt="MoodMirror Logo" />
                    <h1>MoodMirror</h1>
                    <p class="subtitle">Multi-face emotion detection and analysis</p>
                </div>
                <button id="startScanButton">Start Scan</button>
            </div>
        </div>
    </div>

    <!-- SCANNING SCREEN -->
    <div id="scanningScreen" class="screen">
        <div class="container">
            <div class="card card-wide">
                <div class="grid-2col">
                    <div>
                        <div class="video-container">
                            <video id="video" autoplay muted playsinline></video>
                            <canvas id="canvas"></canvas>
                            <div id="scanInfo" class="scan-info">
                                Faces: 0 | Scans: 0 | Duration: 0s
                            </div>
                        </div>
                        <button id="endScanButton" class="secondary">End Scan</button>
                    </div>
                    <div class="emotions-panel">
                        <h3>Live Detection</h3>
                        <div id="liveEmotions"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ANALYTICS SCREEN -->
    <div id="analyticsScreen" class="screen">
        <div class="container">
            <div class="header">
                <h1>Analytics Dashboard</h1>
                <p class="subtitle">Comprehensive emotion analysis report</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalFaces">0</div>
                    <div class="stat-label">Total Faces Detected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalScans">0</div>
                    <div class="stat-label">Total Emotion Scans</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="scanDuration">0s</div>
                    <div class="stat-label">Scan Duration</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Emotion Distribution</h3>
                <canvas id="emotionChart"></canvas>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">Emotion Trends Over Time</h3>
                <canvas id="trendChart"></canvas>
            </div>

            <div class="export-buttons">
                <button id="exportCSVButton">Export as CSV</button>
                <button id="exportJSONButton" class="secondary">Export as JSON</button>
            </div>

            <button id="scanAgainButton" style="margin-top: 12px">Scan Again</button>
        </div>
    </div>

    <script>
        const emotionLabels = {
            neutral: "Neutral",
            happy: "Happy",
            sad: "Sad",
            angry: "Angry",
            fearful: "Fearful",
            disgusted: "Disgusted",
            surprised: "Surprised",
        };

        let video, canvas;
        let isScanning = false;
        let emotionData = [];
        let scanStartTime;
        let detectionInterval;
        let emotionChart, trendChart;
        let scanDurationInterval;

        function showScreen(screenId) {
            document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
            document.getElementById(screenId).classList.add("active");
        }

        async function loadModels() {
            const MODEL_URL = "https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/";
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
            ]);
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720, facingMode: "user" }
                });
                video.srcObject = stream;
                await new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        resolve();
                    };
                });
            } catch (error) {
                alert("Unable to access camera. Please ensure you have granted camera permissions.");
                throw error;
            }
        }

        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (detectionInterval) clearInterval(detectionInterval);
            if (scanDurationInterval) clearInterval(scanDurationInterval);
        }

        async function detectFaces() {
            if (!isScanning) return;

            try {
                const detections = await faceapi
                    .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceExpressions();

                const ctx = canvas.getContext("2d");
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const liveEmotionsContainer = document.getElementById("liveEmotions");
                liveEmotionsContainer.innerHTML = "";

                if (detections && detections.length > 0) {
                    const timestamp = Date.now() - scanStartTime;
                    
                    detections.forEach((detection, index) => {
                        const { box, expressions } = detection;

                        ctx.strokeStyle = "#3182ce";
                        ctx.lineWidth = 3;
                        ctx.strokeRect(box.x, box.y, box.width, box.height);

                        ctx.fillStyle = "#3182ce";
                        ctx.font = "16px sans-serif";
                        ctx.fillText(`Face ${index + 1}`, box.x, box.y - 5);

                        const sorted = Object.entries(expressions).sort(([,a], [,b]) => b - a);
                        const dominantEmotion = sorted[0][0];

                        emotionData.push({
                            timestamp,
                            faceId: index,
                            ...expressions,
                            dominant: dominantEmotion
                        });

                        const faceCard = document.createElement("div");
                        faceCard.className = "face-emotion-card";
                        faceCard.innerHTML = `
                            <h4>Face ${index + 1} - ${emotionLabels[dominantEmotion]}</h4>
                            ${sorted.slice(0, 3).map(([emotion, value]) => `
                                <div class="emotion-bar">
                                    <div class="emotion-bar-label">
                                        <strong>${emotionLabels[emotion]}</strong>
                                        <span>${(value * 100).toFixed(0)}%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-fill" style="width: ${value * 100}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        `;
                        liveEmotionsContainer.appendChild(faceCard);
                    });

                    const uniqueFaces = new Set(emotionData.map(d => d.faceId)).size;
                    const duration = Math.floor((Date.now() - scanStartTime) / 1000);
                    document.getElementById("scanInfo").textContent = 
                        `Faces: ${detections.length} | Scans: ${emotionData.length} | Duration: ${duration}s`;
                }
            } catch (error) {
                console.error("Detection error:", error);
            }
        }

        function updateDuration() {
            const duration = Math.floor((Date.now() - scanStartTime) / 1000);
            const uniqueFaces = new Set(emotionData.map(d => d.faceId)).size;
            document.getElementById("scanInfo").textContent = 
                `Faces: ${uniqueFaces} | Scans: ${emotionData.length} | Duration: ${duration}s`;
        }

        async function startScanning() {
            isScanning = true;
            scanStartTime = Date.now();
            emotionData = [];
            showScreen("scanningScreen");
            
            try {
                await startCamera();
                detectionInterval = setInterval(detectFaces, 500);
                scanDurationInterval = setInterval(updateDuration, 1000);
            } catch (error) {
                isScanning = false;
                showScreen("startScreen");
            }
        }

        function endScanning() {
            isScanning = false;
            stopCamera();
            showAnalytics();
        }

        function showAnalytics() {
            if (emotionData.length === 0) {
                alert("No emotion data collected. Please scan again.");
                showScreen("startScreen");
                return;
            }

            const scanDuration = Math.round((Date.now() - scanStartTime) / 1000);
            const uniqueFaces = new Set(emotionData.map(d => d.faceId)).size;

            document.getElementById("totalFaces").textContent = uniqueFaces;
            document.getElementById("totalScans").textContent = emotionData.length;
            document.getElementById("scanDuration").textContent = scanDuration + "s";

            createEmotionChart();
            createTrendChart();
            
            showScreen("analyticsScreen");
        }

        function createEmotionChart() {
            const emotionCounts = {};
            Object.keys(emotionLabels).forEach(key => {
                emotionCounts[key] = 0;
            });

            emotionData.forEach(scan => {
                emotionCounts[scan.dominant]++;
            });

            const ctx = document.getElementById("emotionChart").getContext("2d");
            if (emotionChart) emotionChart.destroy();

            emotionChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: Object.keys(emotionLabels).map(key => emotionLabels[key]),
                    datasets: [{
                        label: "Emotion Frequency",
                        data: Object.values(emotionCounts),
                        backgroundColor: ["#f3f4f6", "#fef3c7", "#dbeafe", "#fee2e2", "#fed7aa", "#d1fae5", "#e9d5ff"],
                        borderColor: ["#e5e7eb", "#fde68a", "#bfdbfe", "#fecaca", "#fdba74", "#a7f3d0", "#d8b4fe"],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function createTrendChart() {
            const timePoints = 10;
            const interval = Math.max(1, Math.floor(emotionData.length / timePoints));
            const trends = {};

            Object.keys(emotionLabels).forEach(key => {
                trends[key] = [];
            });

            for (let i = 0; i < emotionData.length; i += interval) {
                const chunk = emotionData.slice(i, i + interval);
                Object.keys(emotionLabels).forEach(emotion => {
                    const avg = chunk.reduce((sum, d) => sum + (d[emotion] || 0), 0) / chunk.length;
                    trends[emotion].push((avg * 100).toFixed(1));
                });
            }

            const ctx = document.getElementById("trendChart").getContext("2d");
            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: Array.from({ length: trends.neutral.length }, (_, i) => `T${i + 1}`),
                    datasets: Object.keys(emotionLabels).map(key => ({
                        label: emotionLabels[key],
                        data: trends[key],
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, max: 100, title: { display: true, text: 'Confidence (%)' } },
                        x: { title: { display: true, text: 'Time Segments' } }
                    }
                }
            });
        }

        function exportCSV() {
            let csv = "Timestamp,Face ID,Dominant Emotion,Neutral,Happy,Sad,Angry,Fearful,Disgusted,Surprised\n";
            
            emotionData.forEach(scan => {
                csv += `${scan.timestamp},${scan.faceId},${emotionLabels[scan.dominant]},`;
                csv += `${(scan.neutral * 100).toFixed(2)},${(scan.happy * 100).toFixed(2)},`;
                csv += `${(scan.sad * 100).toFixed(2)},${(scan.angry * 100).toFixed(2)},`;
                csv += `${(scan.fearful * 100).toFixed(2)},${(scan.disgusted * 100).toFixed(2)},`;
                csv += `${(scan.surprised * 100).toFixed(2)}\n`;
            });

            const blob = new Blob([csv], { type: "text/csv" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `moodmirror-scan-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            const exportData = {
                scanDate: new Date().toISOString(),
                duration: Math.round((Date.now() - scanStartTime) / 1000),
                totalFaces: new Set(emotionData.map(d => d.faceId)).size,
                totalScans: emotionData.length,
                emotionData: emotionData
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `moodmirror-scan-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        document.getElementById("startScanButton").addEventListener("click", startScanning);
        document.getElementById("endScanButton").addEventListener("click", endScanning);
        document.getElementById("scanAgainButton").addEventListener("click", () => {
            emotionData = [];
            showScreen("startScreen");
        });
        document.getElementById("exportCSVButton").addEventListener("click", exportCSV);
        document.getElementById("exportJSONButton").addEventListener("click", exportJSON);

        window.addEventListener("load", () => {
            video = document.getElementById("video");
            canvas = document.getElementById("canvas");
            loadModels();
        });
    </script>
</body>
</html>
